<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>年末ジャンボ宝くじシミュレーター | モダン版 v5.8 (Final)</title>
    <meta name="description" content="2024年の実際の当籤番号を元に宝くじの当選をシミュレーション。あなたの運を試してみましょう。">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 基本設定と変数 --- */
        :root {
            --bg-color-start: #2a2a72;
            --bg-color-end: #009ffd;
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border-color: rgba(255, 255, 255, 0.2);
            --text-color: #f0f2f5;
            --text-secondary-color: #b0b3b8;
            --primary-color: #3d9dff;
            --primary-hover-color: #5aa9ff;
            --danger-color: #ff4d4d;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --loader-color: #ffffff;
            --gold-color: #ffd700;
            --silver-color: #c0c0c0;
            --bronze-color: #cd7f32;
            --rank2-color: #e55ea6;
            --rank3-color: #5e89e5;
        }

        :root.light {
            --bg-color-start: #e4e9fd;
            --bg-color-end: #dce7ff;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border-color: rgba(0, 0, 0, 0.1);
            --text-color: #1c1e21;
            --text-secondary-color: #606770;
            --primary-color: #0866ff;
            --primary-hover-color: #0058e0;
            --loader-color: #000000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, var(--bg-color-start), var(--bg-color-end));
            color: var(--text-color);
            transition: background 0.5s, color 0.5s;
            line-height: 1.6;
            background-attachment: fixed;
        }

        button {
            font-family: 'Roboto', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
        }

        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }

        /* --- レイアウトとヘッダー --- */
        .header-container { max-width: 950px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 950px; margin: 1rem auto; padding: 0 1rem; }
        header { text-align: center; margin-bottom: 2rem; color: #fff; flex-grow: 1; }
        header h1 { font-size: 2.8rem; font-weight: 700; text-shadow: 0 2px 8px var(--shadow-color); }
        header p { font-size: 1.2rem; opacity: 0.9; }

        /* --- アイコンボタン共通 --- */
        .icon-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; line-height: 0; }
        .icon-btn svg { width: 28px; height: 28px; fill: var(--text-color); transition: all 0.3s; }
        #settings-btn svg { fill: #fff; }
        #settings-btn:hover svg { transform: rotate(45deg); }
        
        /* --- モーダル (設定画面) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-color-end); border: 1px solid var(--card-border-color);
            padding: 2rem; border-radius: 16px; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { font-size: 1.5rem; }
        .modal-close-btn svg { width: 24px; height: 24px; }
        .modal-close-btn:hover svg { opacity: 0.7; }

        .setting-group { margin-bottom: 2rem; }
        .setting-group h3 { font-size: 1.2rem; margin-bottom: 1rem; border-bottom: 1px solid var(--card-border-color); padding-bottom: 0.5rem;}
        
        .toggle-setting { display: flex; justify-content: space-between; align-items: center; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px;}
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        .modal-footer { margin-top: 2rem; text-align: right; }

        /* --- カードスタイル --- */
        .card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; box-shadow: 0 8px 32px 0 var(--shadow-color); border: 1px solid var(--card-border-color); }
        .card-header { font-size: 1.4rem; font-weight: 500; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--card-border-color); }
        
        /* --- モードセレクター --- */
        .mode-selector { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .mode-tab { flex-grow: 1; padding: 0.8rem 1rem; border: none; background: var(--card-bg); color: var(--text-secondary-color); border-radius: 10px 10px 0 0; cursor: pointer; transition: all 0.3s; font-size: 1rem; font-weight: 500; }
        .mode-tab.active { background: var(--primary-color); color: #fff; }
        .simulation-mode { display: none; }
        .simulation-mode.active { display: block; }

        /* --- コントロール全般 --- */
        .controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1.5rem; }
        .controls button { background-color: var(--primary-color); color: white; border: none; padding: 0.8rem 1.8rem; border-radius: 10px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px -5px rgba(0,0,0,0.4); }
        .controls button:hover:not(:disabled) { background-color: var(--primary-hover-color); transform: translateY(-3px); box-shadow: 0 6px 20px -5px rgba(0,0,0,0.5); }
        .controls button:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }
        .controls button.reset { background-color: #6c757d; }
        .controls button.reset:hover:not(:disabled) { background-color: #5a6268; }

        .speed-control { display: flex; align-items: center; gap: 0.75rem; }
        .speed-control input[type="radio"] { display: none; }
        .speed-control label { padding: 0.5rem 1rem; border: 1px solid var(--card-border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .speed-control input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .ticket-input { background-color: rgba(0,0,0,0.2); border: 1px solid var(--card-border-color); color: var(--text-color); border-radius: 8px; padding: 0.8rem 1rem; font-size: 1.2rem; width: 200px; text-align: center; }
        .ticket-input::placeholder { color: var(--text-secondary-color); }

        .loader { width: 24px; height: 24px; border: 3px solid transparent; border-top-color: var(--loader-color); border-radius: 50%; animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; }
        .loader.hidden { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .latest-ticket-display { text-align: center; font-size: 1.8rem; font-weight: 700; }
        .latest-ticket-display .ticket-number { display: inline-block; background: rgba(0,0,0,0.2); padding: 0.75rem 1.5rem; border-radius: 10px; color: #fff; min-width: 320px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 1.5rem; text-align: center; }
        .summary-item h3 { font-size: 1rem; font-weight: 400; color: var(--text-secondary-color); margin-bottom: 0.25rem; }
        .summary-item p { font-size: 1.8rem; font-weight: 700; }
        .summary-item p.balance-plus { color: #28a745; }
        .summary-item p.balance-minus { color: #dc3545; }

        .result-item-header { display: grid; grid-template-columns: 3fr 2fr 1fr 2fr 1.5fr; padding: 0 1rem; margin-bottom: 0.5rem; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary-color); }
        .result-item-header > div:not(:first-child) { text-align: right; }
        .result-item { display: grid; grid-template-columns: 3fr 2fr 1fr 2fr 1.5fr; align-items: center; padding: 1rem; border-left: 6px solid var(--card-border-color); margin-bottom: 1rem; }
        .result-item.win-animation { animation: win-glow 1s ease-out; }
        @keyframes win-glow { from { box-shadow: 0 0 0 0 var(--win-glow-color); } to { box-shadow: 0 0 25px 12px transparent; } }
        .result-info .rank { font-family: 'Roboto', sans-serif; font-size: 1.2rem; font-weight: 700; }
        .result-info .prize { font-size: 1rem; color: var(--text-secondary-color); }
        .result-info .numbers { font-size: 0.9rem; color: var(--text-secondary-color); margin-top: 0.5rem; word-break: break-all; font-family: 'Roboto Mono', monospace;}
        .result-stat { text-align: right; font-size: 1.1rem; font-weight: 500; }
        .result-stat.latest-win { min-height: 26px; letter-spacing: 1.5px; }

        #rank-1 { border-color: var(--gold-color); }
        #rank-1-zenngo { border-color: var(--silver-color); }
        #rank-1-kumichigai { border-color: var(--bronze-color); }
        #rank-2 { border-color: var(--rank2-color); }
        #rank-3 { border-color: var(--rank3-color); }
        
        /* --- 当選ログ --- */
        #log-card { display: none; /* JSで表示を切り替え */ }
        .log-filter-controls { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.25rem; }
        .log-filter-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 0.4rem 0.9rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .log-filter-btn:hover:not(.active) {
            background-color: #5a6268;
            transform: translateY(-1px);
        }
        .log-filter-btn.active {
            background-color: var(--primary-color);
            box-shadow: 0 4px 12px -4px rgba(61, 157, 255, 0.7);
            transform: translateY(-2px);
        }

        #log-content { max-height: 300px; overflow-y: auto; padding-right: 1rem; }
        #log-content p {
            font-family: 'Roboto Mono', monospace;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--card-border-color);
            word-break: break-all;
            display: flex; gap: 1ch;
            align-items: baseline;
        }
        #log-content p:last-child { border-bottom: none; }
        .log-time { color: var(--text-secondary-color); flex-shrink: 0; }

        footer { text-align: center; margin-top: 3rem; padding: 1.5rem; color: var(--text-secondary-color); font-size: 0.9rem; }

        @media (max-width: 768px) {
            header h1 { font-size: 2.2rem; }
            .card { padding: 1.5rem; }
            .result-item-header { display: none; }
            .result-item { grid-template-columns: 1fr 1fr; gap: 1rem; }
            .result-info { grid-column: 1 / -1; }
            .result-stat { text-align: left; }
            .result-stat::before { content: attr(data-label); display: block; font-size: 0.8rem; color: var(--text-secondary-color); font-weight: 400; }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <header>
            <h1>年末ジャンボ宝くじシミュレーター</h1>
            <p>2024年 第1031回全国自治宝くじ (公式当籤番号準拠)</p>
        </header>
        <button id="settings-btn" class="icon-btn" title="設定">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
              <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
            </svg>
        </button>
    </div>

    <div class="container">
        <main>
            <div class="mode-selector">
                <button class="mode-tab active" data-mode="countup">カウントアップ方式</button>
                <button class="mode-tab" data-mode="instant">一発告知方式</button>
            </div>

            <div id="countup-mode" class="simulation-mode active">
                <div class="card">
                    <div class="controls">
                        <button id="toggle-btn">停止</button>
                        <div class="speed-control">
                            <input type="radio" name="speed" value="500" id="speed-slow"> <label for="speed-slow">遅</label>
                            <input type="radio" name="speed" value="100" id="speed-mid" checked> <label for="speed-mid">中</label>
                            <input type="radio" name="speed" value="1" id="speed-fast"> <label for="speed-fast">速</label>
                        </div>
                        <button id="reset-btn-countup" class="reset">リセット</button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-header">最新の購入くじ番号</h2>
                    <div class="latest-ticket-display">
                        <span id="latest-ticket" class="ticket-number font-mono">---組-------番</span>
                    </div>
                </div>
            </div>

            <div id="instant-mode" class="simulation-mode">
                <div class="card">
                    <div class="controls">
                        <input type="number" id="ticket-amount-input" class="ticket-input font-mono" placeholder="購入枚数を入力" min="1">
                        <button id="start-instant-sim">抽選開始</button>
                        <div class="loader hidden" id="loader-spinner"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-header">シミュレーション結果</h2>
                <div class="summary-grid">
                    <div class="summary-item"><h3>購入金額</h3><p id="total-cost">0 円</p></div>
                    <div class="summary-item"><h3>当選金額</h3><p id="total-win">0 円</p></div>
                    <div class="summary-item"><h3>収支</h3><p id="total-balance">0 円</p></div>
                    <div class="summary-item"><h3>購入枚数</h3><p id="total-tickets">- 枚</p></div>
                    <div class="summary-item"><h3>当選枚数</h3><p id="total-wins-count">- 枚</p></div>
                    <div class="summary-item"><h3>回収率</h3><p id="recovery-rate">- %</p></div>
                    <div class="summary-item"><h3>当選率</h3><p id="win-rate">- %</p></div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-header">当選詳細</h2>
                <div class="result-item-header">
                    <div>等級／当籤金額／当籤番号</div>
                    <div>最新の当せんくじ</div>
                    <div>当せん枚数</div>
                    <div>当せん金額</div>
                    <div>当せん率</div>
                </div>
                <div class="results-grid"></div>
            </div>

            <div id="log-card" class="card">
                <h2 class="card-header">当選ログ (最新100件)</h2>
                <div class="log-filter-controls" id="log-filter-controls"></div>
                <div id="log-content" class="font-mono"></div>
            </div>
        </main>
        
        <footer>
            <p>このシミュレーターは、2024年 第1031回全国自治宝くじの実際の当籤番号に基づいています。実際の当選を保証するものではありません。</p>
        </footer>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>設定</h2>
                <button id="modal-close-btn" class="icon-btn modal-close-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <h3>カウントアップ方式 設定</h3>
                    <div class="toggle-setting">
                        <label for="step-amount-input">1ステップあたりの購入枚数</label>
                        <input type="number" id="step-amount-input" class="ticket-input font-mono" value="1" min="1" style="width: 120px; font-size: 1rem;">
                    </div>
                </div>
                 <div class="setting-group">
                    <h3>当選確率の変更 (現在無効)</h3>
                    <p style="color: var(--text-secondary-color);">このシミュレーターは実際の当籤番号に基づいているため、確率設定は無効化されています。</p>
                </div>
                <div class="setting-group">
                    <h3>ログ表示設定</h3>
                    <div class="toggle-setting">
                        <p>当選ログを表示する</p>
                        <label class="switch">
                            <input type="checkbox" id="toggle-log-display" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="toggle-setting" style="margin-top: 1rem;">
                        <p>ログ非表示中でも当選を記録する</p>
                        <label class="switch">
                            <input type="checkbox" id="toggle-background-log" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-group">
                    <h3>モード間の結果引き継ぎ</h3>
                    <div class="toggle-setting">
                        <p>モードを切り替えても結果を維持する</p>
                        <label class="switch">
                            <input type="checkbox" id="persist-results-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer controls">
                 <button id="reset-settings-btn" class="reset">設定をリセット</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const getEl = (id) => document.getElementById(id);
            const query = (sel) => document.querySelector(sel);
            const queryAll = (sel) => document.querySelectorAll(sel);
            
            // --- DOM要素 ---
            const modeTabs = queryAll('.mode-tab');
            const toggleBtn = getEl('toggle-btn');
            const resetBtnUp = getEl('reset-btn-countup');
            const speedRadios = queryAll('input[name="speed"]');
            const latestTicketEl = getEl('latest-ticket');
            const ticketAmountInput = getEl('ticket-amount-input');
            const startInstantBtn = getEl('start-instant-sim');
            const loader = getEl('loader-spinner');
            const totalCostEl = getEl('total-cost');
            const totalWinEl = getEl('total-win');
            const totalBalanceEl = getEl('total-balance');
            const totalTicketsEl = getEl('total-tickets');
            const totalWinsCountEl = getEl('total-wins-count');
            const recoveryRateEl = getEl('recovery-rate');
            const winRateEl = getEl('win-rate');
            const resultsGrid = query('.results-grid');
            const settingsBtn = getEl('settings-btn');
            const settingsModal = getEl('settings-modal');
            const modalCloseBtn = getEl('modal-close-btn');
            const persistResultsToggle = getEl('persist-results-toggle');
            const resetSettingsBtn = getEl('reset-settings-btn');
            const stepAmountInput = getEl('step-amount-input');
            const logCard = getEl('log-card');
            const logContent = getEl('log-content');
            const logFilterControls = getEl('log-filter-controls');
            const toggleLogDisplay = getEl('toggle-log-display');
            const toggleBackgroundLog = getEl('toggle-background-log'); // ★ NEW

            // --- 状態管理 ---
            let simState = {
                isRunning: false,
                speed: 100,
                intervalId: null,
                currentMode: 'countup',
                persistResults: false,
                stepAmount: 1, 
                currentLogFilter: 'all',
                showLog: true,
                recordLogInBackground: true, // ★ NEW
            };
            
            const MAX_LOG_COUNT = 100;

            // --- 当選データ ---
            const PRIZE_DEFINITIONS = {
                'rank-1':           { rank: '1等', prize: 700000000 },
                'rank-1-zenngo':    { rank: '1等の前後賞', prize: 150000000 },
                'rank-1-kumichigai':{ rank: '1等の組違い賞', prize: 100000 },
                'rank-2':           { rank: '2等', prize: 10000000 },
                'rank-3':           { rank: '3等', prize: 1000000 },
                'rank-4':           { rank: '4等', prize: 50000 },
                'rank-5':           { rank: '5等', prize: 10000 },
                'rank-6':           { rank: '6等', prize: 3000 },
                'rank-7':           { rank: '7等', prize: 300 },
            };

            const WINNING_NUMBERS = {
                'rank-1': { kumi: 110, bango: 106348 },
                'rank-2': [
                    { kumi: 52, bango: 151307 }, { kumi: 49, bango: 135439 },
                    { kumi: 139, bango: 167124 }, { kumi: 65, bango: 138164 },
                    { kumi: 60, bango: 122015 }, { kumi: 46, bango: 116185 },
                    { kumi: 60, bango: 110493 }, { kumi: 84, bango: 120749 }
                ],
                'rank-3': { bango: [103265, 164169] }, // ★ BUG FIX: Corrected to full 6-digit numbers
                'rank-4': { bango: 6135 },
                'rank-5': { bango: 896 },
                'rank-6': { bango: 64 },
                'rank-7': { bango: 6 },
            };

            // --- 結果データ管理 ---
            let resultsData;

            function initializeResults(forceNew = false) {
                if (!simState.persistResults || forceNew || !resultsData) {
                    resultsData = {
                        totalCost: 0, totalWin: 0, totalTickets: 0, totalWinsCount: 0,
                        prizes: {},
                        logEntries: [],
                    };
                    Object.keys(PRIZE_DEFINITIONS).forEach(id => {
                        resultsData.prizes[id] = { count: 0, amount: 0, latestWin: null };
                    });
                }
                resetSettings();
                updateAllDisplays();
                latestTicketEl.textContent = '---組-------番';
            }

            function initializeUI() {
                resultsGrid.innerHTML = '';
                Object.entries(PRIZE_DEFINITIONS).forEach(([id, def]) => {
                    const el = document.createElement('div');
                    el.className = 'card result-item';
                    el.id = id;
                    
                    let numbersHtml = '';
                    if (id === 'rank-1') {
                        const { kumi, bango } = WINNING_NUMBERS[id];
                        numbersHtml = `当籤番号: ${String(kumi).padStart(3, '0')}組 ${String(bango).padStart(6, '0')}番`;
                    } else if (id === 'rank-1-zenngo') {
                        numbersHtml = `1等の前後の番号`;
                    } else if (id === 'rank-1-kumichigai') {
                        numbersHtml = `1等と組違いの同番号`;
                    } else if (id === 'rank-2') {
                         numbersHtml = WINNING_NUMBERS[id].map(n => `${String(n.kumi).padStart(3,'0')}組 ${String(n.bango).padStart(6,'0')}番`).join('<br>');
                    } else if (id === 'rank-3') {
                        // ★ BUG FIX: Display corrected 6-digit numbers as "common"
                        const numbers = WINNING_NUMBERS[id].bango.map(n => `${n}番`);
                        numbersHtml = `各組共通 ${numbers.join(', ')}`;
                    } else if (id === 'rank-4') {
                        numbersHtml = `下4ケタ: ${String(WINNING_NUMBERS[id].bango).padStart(4,'0')}`;
                    } else if (id === 'rank-5') {
                        numbersHtml = `下3ケタ: ${String(WINNING_NUMBERS[id].bango).padStart(3,'0')}`;
                    } else if (id === 'rank-6') {
                        numbersHtml = `下2ケタ: ${String(WINNING_NUMBERS[id].bango).padStart(2,'0')}`;
                    } else if (id === 'rank-7') {
                        numbersHtml = `下1ケタ: ${WINNING_NUMBERS[id].bango}`;
                    }

                    el.innerHTML = `
                        <div class="result-info">
                            <div class="rank">${def.rank}</div>
                            <div class="prize">${def.prize.toLocaleString()}円</div>
                            <div class="numbers">${numbersHtml}</div>
                        </div>
                        <div class="result-stat latest-win font-mono" data-label="最新の当せんくじ" data-stat="latest">-</div>
                        <div class="result-stat" data-label="当せん枚数" data-stat="count">0</div>
                        <div class="result-stat" data-label="当せん金額" data-stat="amount">0円</div>
                        <div class="result-stat" data-label="当せん率" data-stat="rate">0.000%</div>`;
                    resultsGrid.appendChild(el);
                });

                logFilterControls.innerHTML = '';
                const allBtn = document.createElement('button');
                allBtn.className = 'log-filter-btn active';
                allBtn.textContent = 'すべて';
                allBtn.dataset.rank = 'all';
                logFilterControls.appendChild(allBtn);

                Object.entries(PRIZE_DEFINITIONS).forEach(([id, def]) => {
                    const btn = document.createElement('button');
                    btn.className = 'log-filter-btn';
                    btn.textContent = def.rank;
                    btn.dataset.rank = id;
                    logFilterControls.appendChild(btn);
                });
            }

            function updateAllDisplays() {
                totalCostEl.textContent = `${resultsData.totalCost.toLocaleString()} 円`;
                totalWinEl.textContent = `${resultsData.totalWin.toLocaleString()} 円`;
                const balance = resultsData.totalWin - resultsData.totalCost;
                totalBalanceEl.textContent = `${balance.toLocaleString()} 円`;
                totalBalanceEl.className = balance >= 0 ? 'balance-plus' : 'balance-minus';
                totalTicketsEl.textContent = `${resultsData.totalTickets.toLocaleString()} 枚`;
                totalWinsCountEl.textContent = `${resultsData.totalWinsCount.toLocaleString()} 枚`;
                const recoveryRate = resultsData.totalCost > 0 ? (resultsData.totalWin / resultsData.totalCost * 100).toFixed(2) : '0.00';
                const winRate = resultsData.totalTickets > 0 ? (resultsData.totalWinsCount / resultsData.totalTickets * 100).toFixed(4) : '0.0000';
                recoveryRateEl.textContent = `${recoveryRate} %`;
                winRateEl.textContent = `${winRate} %`;

                Object.keys(PRIZE_DEFINITIONS).forEach(id => {
                    const pData = resultsData.prizes[id];
                    const pEl = getEl(id);
                    if (pEl) {
                        pEl.querySelector('[data-stat="count"]').textContent = pData.count.toLocaleString();
                        pEl.querySelector('[data-stat="amount"]').textContent = pData.amount.toLocaleString() + '円';
                        pEl.querySelector('[data-stat="latest"]').textContent = pData.latestWin ? `${String(pData.latestWin.kumi).padStart(3, '0')}組 ${String(pData.latestWin.bango).padStart(6, '0')}番` : '-';
                        const rate = resultsData.totalTickets > 0 ? (pData.count / resultsData.totalTickets * 100).toFixed(6) : '0.000000';
                        pEl.querySelector('[data-stat="rate"]').textContent = `${rate}%`;
                    }
                });
            }
            
            function formatTime(date) {
                const pad = (n) => String(n).padStart(2, '0');
                return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
            }

            // --- ログ関連処理 ---
            function logWin(prizeId, kumi, bango) {
                // ★ NEW: Check if we should record the log at all.
                if (simState.showLog || simState.recordLogInBackground) {
                    if (resultsData.logEntries.length >= MAX_LOG_COUNT) {
                        resultsData.logEntries.shift(); 
                    }
                    resultsData.logEntries.push({
                        prizeId: prizeId, kumi: kumi, bango: bango,
                        ticketCount: resultsData.totalTickets,
                        timestamp: new Date()
                    });
                }
                updateLogDisplay();
            }

            function getRankColor(prizeId) {
                if (prizeId === 'rank-1') return 'var(--gold-color)';
                if (prizeId === 'rank-1-zenngo') return 'var(--silver-color)';
                if (prizeId === 'rank-1-kumichigai') return 'var(--bronze-color)';
                if (prizeId === 'rank-2') return 'var(--rank2-color)';
                if (prizeId === 'rank-3') return 'var(--rank3-color)';
                return 'var(--text-color)';
            }
            
            function updateLogDisplay() {
                if (!simState.showLog) {
                    logCard.style.display = 'none';
                    return;
                }
                
                logCard.style.display = 'block';

                const filteredLogs = simState.currentLogFilter === 'all'
                    ? resultsData.logEntries
                    : resultsData.logEntries.filter(log => log.prizeId === simState.currentLogFilter);

                let logHtml = '';
                if (resultsData.logEntries.length === 0) {
                     logHtml = '<p>まだ当選はありません。</p>';
                } else if (filteredLogs.length > 0) {
                    logHtml = filteredLogs.map(log => {
                        const def = PRIZE_DEFINITIONS[log.prizeId];
                        const ticketNumberText = `${String(log.kumi).padStart(3, '0')}組 ${String(log.bango).padStart(6, '0')}番`;
                        const rankColor = getRankColor(log.prizeId);
                        return `<p><span class="log-time">[${formatTime(log.timestamp)}]</span><span>[${log.ticketCount.toLocaleString()}枚目] <strong style="color: ${rankColor}">${def.rank}</strong> 当せん！ (${ticketNumberText})</span></p>`;
                    }).join('');
                } else {
                    logHtml = '<p>この等級の当選はまだありません。</p>';
                }
                
                logContent.innerHTML = logHtml;
                if (filteredLogs.length > 0) {
                    logContent.scrollTop = logContent.scrollHeight;
                }
            }

            // --- 抽選ロジック ---
            function checkWin(kumi, bango) {
                if (kumi === WINNING_NUMBERS['rank-1'].kumi && bango === WINNING_NUMBERS['rank-1'].bango) { recordWin('rank-1', kumi, bango); return; }
                if (kumi === WINNING_NUMBERS['rank-1'].kumi && Math.abs(bango - WINNING_NUMBERS['rank-1'].bango) === 1) { recordWin('rank-1-zenngo', kumi, bango); }
                if (kumi !== WINNING_NUMBERS['rank-1'].kumi && bango === WINNING_NUMBERS['rank-1'].bango) { recordWin('rank-1-kumichigai', kumi, bango); }
                for (const winNum of WINNING_NUMBERS['rank-2']) { if (kumi === winNum.kumi && bango === winNum.bango) { recordWin('rank-2', kumi, bango); break; }}
                // ★ BUG FIX: Correctly check against the full 6-digit number, not modulo
                if (WINNING_NUMBERS['rank-3'].bango.includes(bango)) { recordWin('rank-3', kumi, bango); }
                if (bango % 10000 === WINNING_NUMBERS['rank-4'].bango) { recordWin('rank-4', kumi, bango); }
                if (bango % 1000 === WINNING_NUMBERS['rank-5'].bango) { recordWin('rank-5', kumi, bango); }
                if (bango % 100 === WINNING_NUMBERS['rank-6'].bango) { recordWin('rank-6', kumi, bango); }
                if (bango % 10 === WINNING_NUMBERS['rank-7'].bango) { recordWin('rank-7', kumi, bango); }
            }

            function recordWin(prizeId, kumi, bango) {
                const prizeAmount = PRIZE_DEFINITIONS[prizeId].prize;
                const pData = resultsData.prizes[prizeId];
                pData.count++;
                pData.amount += prizeAmount;
                pData.latestWin = { kumi, bango };
                resultsData.totalWin += prizeAmount;
                resultsData.totalWinsCount++;
                logWin(prizeId, kumi, bango); 
                const pEl = getEl(prizeId);
                if(pEl) {
                    pEl.classList.remove('win-animation');
                    void pEl.offsetWidth; 
                    pEl.classList.add('win-animation');
                }
            }
            
            // --- カウントアップ方式の処理 ---
            function runCountUpStep() {
                if (!simState.isRunning) return;
                const amount = simState.stepAmount;
                let kumi, bango;
                for (let i = 0; i < amount; i++) {
                    resultsData.totalTickets++;
                    resultsData.totalCost += 300;
                    kumi = Math.floor(Math.random() * 200) + 1;
                    bango = Math.floor(Math.random() * 100000) + 100000;
                    checkWin(kumi, bango);
                }
                if (kumi && bango) {
                    latestTicketEl.textContent = `${String(kumi).padStart(3, '0')}組 ${String(bango).padStart(6, '0')}番`;
                }
                updateAllDisplays();
            }
            function startCountUp() {
                if (simState.intervalId) clearInterval(simState.intervalId);
                simState.isRunning = true;
                simState.intervalId = setInterval(runCountUpStep, simState.speed);
                toggleBtn.textContent = '停止';
            }
            function stopCountUp() {
                clearInterval(simState.intervalId);
                simState.intervalId = null;
                simState.isRunning = false;
                toggleBtn.textContent = '再開';
            }
            
            // --- 一発告知方式の処理 ---
            function runInstantSim() {
                const amount = parseInt(ticketAmountInput.value, 10);
                if (!amount || amount <= 0) { alert('正しい購入枚数を入力してください。'); return; }
                if(!simState.persistResults) { initializeResults(true); }
                startInstantBtn.disabled = true; loader.classList.remove('hidden');
                setTimeout(() => { 
                    for (let i = 0; i < amount; i++) {
                        resultsData.totalTickets++;
                        resultsData.totalCost += 300;
                        const kumi = Math.floor(Math.random() * 200) + 1;
                        const bango = Math.floor(Math.random() * 100000) + 100000;
                        checkWin(kumi, bango);
                    }
                    updateAllDisplays();
                    startInstantBtn.disabled = false; loader.classList.add('hidden');
                }, 50);
            }
            
            // --- 設定リセット処理 ---
            function resetSettings() {
                stepAmountInput.value = 1; simState.stepAmount = 1;
                persistResultsToggle.checked = false; simState.persistResults = false;
                toggleLogDisplay.checked = true; simState.showLog = true;
                toggleBackgroundLog.checked = true; simState.recordLogInBackground = true; // ★ NEW
                simState.currentLogFilter = 'all';
                logFilterControls.querySelectorAll('.log-filter-btn').forEach(btn => btn.classList.remove('active'));
                logFilterControls.querySelector('[data-rank="all"]').classList.add('active');
                updateLogDisplay();
            }

            // --- イベントリスナー ---
            modeTabs.forEach(tab => tab.addEventListener('click', () => {
                stopCountUp(); const newMode = tab.dataset.mode;
                if (newMode === simState.currentMode) return;
                simState.currentMode = newMode;
                modeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                queryAll('.simulation-mode').forEach(m => m.classList.remove('active'));
                getEl(`${newMode}-mode`).classList.add('active');
                if (!simState.persistResults) { initializeResults(true); }
                if(newMode === 'countup') startCountUp();
            }));

            logFilterControls.addEventListener('click', (e) => {
                if(e.target.matches('.log-filter-btn')) {
                    const rank = e.target.dataset.rank;
                    simState.currentLogFilter = rank;
                    logFilterControls.querySelectorAll('.log-filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateLogDisplay();
                }
            });

            toggleBtn.addEventListener('click', () => simState.isRunning ? stopCountUp() : startCountUp());
            resetBtnUp.addEventListener('click', () => { stopCountUp(); initializeResults(true); startCountUp(); });
            speedRadios.forEach(radio => radio.addEventListener('change', (e) => { simState.speed = parseInt(e.target.value, 10); if (simState.isRunning) startCountUp(); }));
            startInstantBtn.addEventListener('click', runInstantSim);
            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            modalCloseBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.classList.remove('active'); });
            
            stepAmountInput.addEventListener('change', (e) => {
                const value = parseInt(e.target.value, 10);
                simState.stepAmount = value > 0 ? value : 1;
                e.target.value = simState.stepAmount;
            });
            persistResultsToggle.addEventListener('change', (e) => { simState.persistResults = e.target.checked; });
            toggleLogDisplay.addEventListener('change', (e) => {
                simState.showLog = e.target.checked;
                updateLogDisplay();
            });
            // ★ NEW
            toggleBackgroundLog.addEventListener('change', (e) => {
                simState.recordLogInBackground = e.target.checked;
            });
            resetSettingsBtn.addEventListener('click', resetSettings);

            const darkModeMatcher = window.matchMedia('(prefers-color-scheme: dark)');
            function applyTheme(isDark) { document.documentElement.classList.toggle('light', !isDark); }
            darkModeMatcher.addEventListener('change', e => applyTheme(e.matches));
            applyTheme(darkModeMatcher.matches);

            // --- 初期実行 ---
            initializeUI();
            initializeResults(true);
            startCountUp();
        });
    </script>
</body>
</html>
